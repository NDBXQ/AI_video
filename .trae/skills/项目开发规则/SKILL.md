---
name: 项目开发规则
description: 涉及到项目开发的时候，需要使用这个技能
---

## 一、模块化开发核心原则

代码开发与项目构建需遵循**模块化+结构化**设计原则，保障代码逻辑清晰、可维护性强、可扩展性高、 代码可读性强、 有中文注释。

## 二、代码文件规范

1. **单文件内容限制**：脚本文件代码行数建议不超过300行（核心目的：减少模型token消耗，避免上下文过载引发的模型记忆偏差与处理效果下降）；若按字数统计，内容上限建议不超过1万字，可根据文件类型与业务场景择一执行。
2. **模块化拆分要求**：强制实现**组件模块化**、**CSS样式模块化**，后续新增所有代码均需严格遵循此标准进行开发与提交。

## 三、项目结构要求

采用**自上而下**的分层开发逻辑，确保项目整体架构层次分明、目录结构清晰、模块命名规范统一（符合行业通用命名约定与项目内部共识）。

## 四、前端技术选型（强制）

前端采用 `React + Next.js（App Router）`。所有页面与路由能力以 `app/` 目录约定为准。

## 五、函数注释规范（强制）

所有函数必须添加标准化清晰注释，明确函数功能、输入参数、返回值类型，示例如下：

```JavaScript
/**
 * 获取工作项详细信息
 * @param {string} token - 插件身份验证token
 * @returns {Promise<Object>} 包含工作项完整信息的Promise对象
 */
```



## 七、日志书写规范（强制执行）

为保障可观测性、可追溯性与排障效率，所有新增/调整/修复代码必须遵循以下日志规范（未满足视为不合格交付）。

### 7.1 日志等级（必须分级）

- `debug`：开发调试信息（默认不在生产环境开启或需可开关）
- `info`：关键业务流程节点（开始/结束/重要状态变化/关键结果摘要）
- `warn`：可恢复异常、降级/重试、边界输入、非致命风险
- `error`：影响主流程的失败、不可恢复异常、关键依赖不可用

### 7.2 日志内容结构（必须结构化）

- 统一使用结构化字段（JSON 或对象形式），避免纯字符串堆叠
- 必填字段（每条日志至少包含）：
  - `event`：事件名（动宾结构，例：`video_upload_start`、`task_fetch_failed`）
  - `module`：模块名（例：`auth`、`editor`、`payment`）
  - `traceId`：链路标识（同一次请求/任务保持一致）
  - `timestamp`：时间（由日志系统生成也可）
  - `level`：日志级别
  - `message`：简短可读描述（1 句）
- 推荐字段（按需补充）：
  - `userId`（可脱敏/不可逆标识）、`sessionId`、`requestId`
  - `route/page`、`api`、`method`、`statusCode`
  - `durationMs`（耗时）、`retryCount`、`payloadSize`
  - `resultSummary`（结果摘要，禁止记录原始大对象）

### 7.3 关键节点必须打点（覆盖主链路）

每个“新功能/调整/修复”至少覆盖以下节点（按实际流程增减）：

1. **入口日志**：参数接收、上下文信息（不含敏感数据）
2. **关键分支**：条件分支选择原因（例如走了降级/缓存/兜底）
3. **外部依赖**：接口请求发起/响应摘要（含耗时、状态码、重试情况）
4. **数据处理**：关键转换结果摘要（数量、范围、校验结论）
5. **结束日志**：成功/失败，输出关键结果与耗时

### 7.4 异常日志规范（必须可定位）

- `error` 日志必须包含：
  - `event`（以 `_failed` 结尾更清晰）
  - `errorName`、`errorMessage`
  - `stack`（如环境允许）
  - `context`（最小必要上下文：输入摘要、依赖信息、当前状态）
- 不允许只打印“报错了/失败了”这种不可行动信息

### 7.5 性能与慢操作日志（必须可度量）

- 对以下场景必须记录 `durationMs`：
  - 页面关键渲染、文件处理/上传、批量任务、网络请求、复杂计算
- 建议设置慢阈值：
  - 超过阈值输出 `warn`（例如 `durationMs > X`），并包含影响范围与可能原因

### 7.6 禁止项（安全与合规）

- 严禁记录任何敏感信息或可复用凭证：
  - token、cookie、authorization header、密码、验证码、私钥、支付卡号、完整手机号/身份证号等
- 用户数据必须遵循“最小化 + 脱敏”：
  - 仅记录必要摘要；长文本/大对象禁止原样写入日志（必要时截断并标记 `truncated: true`）

### 7.7 命名与示例（统一可检索）

- `event` 命名推荐：`<domain>_<action>_<state>`例：`workitem_fetch_start` / `workitem_fetch_success` / `workitem_fetch_failed`
- 示例（结构化）：

```js
logger.info({
  event: "workitem_fetch_start",
  module: "workitem",
  traceId,
  message: "开始获取工作项详情",
  workItemId,
})

logger.error({
  event: "workitem_fetch_failed",
  module: "workitem",
  traceId,
  message: "获取工作项详情失败",
  workItemId,
  durationMs,
  errorName: err?.name,
  errorMessage: err?.message,
  stack: err?.stack,
})
```

## 八、Next.js App Router 工程规范（强制执行）

### 8.1 Server / Client Components 边界（必须明确）

- 默认使用 **Server Component**；仅在需要浏览器能力时使用 `"use client"`（例如：交互事件、useState/useEffect、访问 window/localStorage、仅浏览器可用第三方库）。
- Client Component 禁止直接读取服务端敏感配置与密钥；涉及 token/密钥的逻辑必须在服务端完成。

### 8.2 路由与文件约定（必须遵循）

- 必须遵循 App Router 文件约定：`page.tsx`、`layout.tsx`、`loading.tsx`、`error.tsx`、`not-found.tsx`、`route.ts`（如使用）。
- 错误与加载需尽量在对应路由段落地，避免全局兜底导致定位困难。

### 8.3 数据获取与缓存策略（必须声明）

- 每个关键数据请求必须明确缓存策略与原因：默认遵循 Next.js 行为；需要实时数据时必须显式声明（禁用缓存/设置 revalidate）。
- 关键页面（列表/详情/编辑）必须说明：数据来源、缓存策略、失败兜底（空态/重试/错误提示）。

### 8.4 Route Handlers / Server Actions 规范（如使用必须统一）

- 服务端能力优先放在服务端（Route Handler 或 Server Action），并保持：
  - 输入校验（最小必要校验）
  - 输出结构统一（见第十章错误结构）
  - 日志满足第七章（尤其 `event/module/traceId/durationMs`）
- 前端请求必须处理：超时/失败/空数据/权限失败四类最小场景。

### 8.5 样式与组件组织（与模块化要求一致）

- 页面只做编排；业务组件放 `src/features/**`；通用组件放 `src/components/**`（若项目已有约定，以已有为准但必须一致）。
- CSS 必须模块化（CSS Modules 或项目既有方案），禁止无约束的全局污染（除全局 reset/theme 外）。

## 九、类型与数据校验规范（强制执行）

- TypeScript 类型必须完整表达边界：接口入参、接口返回、组件 props、关键状态结构。
- 外部输入必须做运行时校验（HTTP 请求体、query、第三方回调、localStorage 读出值等）；如项目已有校验库，必须复用。
- 关键数据结构变更必须同步更新：类型定义、映射逻辑、兜底逻辑与相关测试/用例。

## 十、错误结构与错误码规范（强制执行）

### 10.1 统一错误返回结构（服务端接口/route handler 必须一致）

- 成功返回：
  - `ok: true`
  - `data: <payload>`
  - `traceId`
- 失败返回：
  - `ok: false`
  - `error: { code, message }`
  - `traceId`

### 10.2 错误码原则

- `code` 必须稳定可检索（用于埋点/告警/排障），禁止随意改名。
- `message` 面向开发/排障，避免泄露敏感信息；用户可见文案应由前端映射或另行字段承载。

### 10.3 前端错误处理原则

- UI 层必须区分：可重试（网络/超时）、不可重试（参数校验失败）、权限问题（登录/刷新授权）、空数据（空态）。
- 同一错误码必须呈现一致交互（toast/inline/弹窗/跳转）。

## 十一、安全与配置规范（强制执行）

- 密钥与敏感配置只能通过环境变量注入，严禁写入仓库与日志。
- 仅 `NEXT_PUBLIC_*` 可暴露给客户端；其他环境变量默认视为服务端私密。
- 所有请求鉴权与权限判断必须在服务端或可信边界完成，前端仅做展示与交互控制。

## 十二、测试与质量门禁（强制执行）

- 每次交付必须保证：lint/typecheck/build（按项目既有命令执行）。
- 对高风险改动必须提供至少一种验证手段：
  - 单测/组件测试/接口测试其一，或最小可复现步骤（包含数据准备与预期结果）。
- 修复类需求必须提供：复现条件、修复点解释、修复后验证步骤。

## 十三、交付与验收规范（强制执行）

每次输出“开发/调整/修复”的最终交付，必须同时给出：

1. **改动摘要**：一句话说明目标与结果；
2. **改动文件清单**：列出新增/修改文件路径；
3. **核心逻辑说明**：关键数据流/状态流、关键边界处理；
4. **验证方案**：如何验证生效（包含命令、入口、用例步骤）；
5. **风险点与回滚点（可选但推荐）**：潜在影响范围与回滚方式。